/*! For license information please see sir-trevor.a93d11b46dd59ead6f69.js.LICENSE.txt */
/*!
 * sense-client@7.144.6
 * 
 * Copyright(C) 2021 Qlik International AB
 * All Rights Reserved
 * 
 */
(window["qJsonp"]=window["qJsonp"]||[]).push([[16],{"8T2z":function(t,e,i){var n=i("qIEf");var o=i("PoH+");var s=i("dNq/");(function(t,e){var i=this,o;o=i.SirTrevor={};o.DEBUG=false;o.SKIP_VALIDATION=false;o.version="0.3.0";o.LANGUAGE="en";function r(e){return e instanceof t?e:t(e)}o.DEFAULTS={defaultType:false,spinner:{className:"st-spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:false,left:"50%",top:"50%"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/",errorsContainer:void 0};o.BlockMixins={};o.Blocks={};o.Formatters={};o.instances=[];o.Events=s;var a=false;var l={bound:[],_bindFunctions:function(){this.bound.length>0&&e.bindAll.apply(null,e.union([this],this.bound))}};var c={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(t){return this.$el.find(t)},render:function(){return this},destroy:function(){e.isUndefined(this.stopListening)||this.stopListening();this.$el.remove()},_ensureElement:function(){if(this.el)this._setElement(this.el);else{var i=e.extend({},e.result(this,"attributes")),n;this.id&&(i.id=this.id);this.className&&(i["class"]=this.className);if(i.html){n=i.html;delete i.html}var o=t("<"+this.tagName+">").attr(i);n&&o.html(n);this._setElement(o)}},_setElement:function(t){this.$el=r(t);this.el=this.$el[0];return this}};function d(t,e){var i=-1,n=-1,o=e.length,s=t.length;for(var r=0;r<o;r++){-1==i&&t.substr(r,1)!=e.substr(r,1)&&(i=r-1);-1==n&&t.substr(s-r-1,1)!=e.substr(o-r-1,1)&&(n=r)}return{result:e.substr(i,o-n-i+1),pos1:i,pos2:n}}(function(t){function e(t){t.preventDefault()}function i(e){e.originalEvent.dataTransfer.dropEffect="copy";t(e.currentTarget).addClass("st-drag-over");e.preventDefault()}function n(e){t(e.currentTarget).removeClass("st-drag-over");e.preventDefault()}t.fn.dropArea=function(){this.bind("dragenter",e).bind("dragover",i).bind("dragleave",n);return this};t.fn.noDropArea=function(){this.unbind("dragenter").unbind("dragover").unbind("dragleave");return this};t.fn.caretToEnd=function(){var t,e;t=document.createRange();t.selectNodeContents(this[0]);t.collapse(false);e=window.getSelection();e.removeAllRanges();e.addRange(t);return this}})(n);var u=function(t,i){var n=this;var o;o=t&&e.has(t,"constructor")?t.constructor:function(){return n.apply(this,arguments)};e.extend(o,n,i);var s=function(){this.constructor=o};s.prototype=n.prototype;o.prototype=new s;t&&e.extend(o.prototype,t);o.__super__=n.prototype;return o};o.log=function(t){!e.isUndefined(console)&&o.DEBUG&&console.log(t)};o.Locales={en:{general:{delete:"Delete?",drop:"Drag __block__ here",paste:"Or paste URL here",upload:"...or choose a file",close:"close",position:"Position",wait:"Please wait...",link:"Enter a link"},errors:{title:"You have the following errors:",validation_fail:"__type__ block is invalid",block_empty:"__name__ must not be empty",type_missing:"You must have a block of type __type__",required_type_empty:"A required block type __type__ is empty",load_fail:"There was a problem loading the contents of the document"},blocks:{text:{title:"Text"},list:{title:"List"},quote:{title:"Quote",credit_field:"Credit"},image:{title:"Image",upload_error:"There was a problem with your upload"},video:{title:"Video"},embedly:{title:"Embedly",fetch_error:"There was a problem fetching your embed",key_missing:"An Embedly API key must be present"},heading:{title:"Heading"}}}};if(void 0===window.i18n){o.log("Using i18n stub");window.i18n={t:function(t,i){var n=t.split(":"),s,r,a,l;r=o.Locales[o.LANGUAGE];for(l=0;l<n.length;l++){a=n[l];e.isUndefined(r[a])||(r=r[a])}s=r;if(!e.isString(s))return"";s.indexOf("__")>=0&&e.each(i,(function(t,e){s=s.replace("__"+e+"__",t)}));return s}}}else{o.log("Using i18next");i18n.init({resStore:o.Locales,fallbackLng:o.LANGUAGE,ns:{namespaces:["general","blocks"],defaultNs:"general"}})}(function(t,e,i){function n(t,i){var n=e.createElement(t||"div"),o;for(o in i)n[o]=i[o];return n}function o(t){for(var e=1,i=arguments.length;e<i;e++)t.appendChild(arguments[e]);return t}function s(t,e,i,n){var o=["opacity",e,~~(100*t),i,n].join("-"),s=.01+i/n*100,r=Math.max(1-(1-t)/e*(100-s),t),a=h.substring(0,h.indexOf("Animation")).toLowerCase(),l=a&&"-"+a+"-"||"";return u[o]||(p.insertRule("@"+l+"keyframes "+o+"{0%{opacity:"+r+"}"+s+"%{opacity:"+t+"}"+(s+.01)+"%{opacity:1}"+(s+e)%100+"%{opacity:"+t+"}100%{opacity:"+r+"}}",0),u[o]=1),o}function r(t,e){var n=t.style,o,s;if(n[e]!==i)return e;e=e.charAt(0).toUpperCase()+e.slice(1);for(s=0;s<d.length;s++){o=d[s]+e;if(n[o]!==i)return o}}function a(t,e){for(var i in e)t.style[r(t,i)||i]=e[i];return t}function l(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)t[o]===i&&(t[o]=n[o])}return t}function c(t){var e={x:t.offsetLeft,y:t.offsetTop};while(t=t.offsetParent)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e}var d=["webkit","Moz","ms","O"],u={},h,p=function(){var t=n("style");return o(e.getElementsByTagName("head")[0],t),t.sheet||t.styleSheet}(),f={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},b=function t(e){if(!this.spin)return new t(e);this.opts=l(e||{},t.defaults,f)};b.defaults={},l(b.prototype,{spin:function(t){this.stop();var e=this,i=e.opts,o=e.el=a(n(0,{className:i.className}),{position:"relative",zIndex:i.zIndex}),s=i.radius+i.length+i.width,r,l;t&&(t.insertBefore(o,t.firstChild||null),l=c(t),r=c(o),a(o,{left:("auto"==i.left?l.x-r.x+(t.offsetWidth>>1):i.left+s)+"px",top:("auto"==i.top?l.y-r.y+(t.offsetHeight>>1):i.top+s)+"px"})),o.setAttribute("aria-role","progressbar"),e.lines(o,e.opts);if(!h){var d=0,u=i.fps,p=u/i.speed,f=(1-i.opacity)/(p*i.trail/100),b=p/i.lines;!function t(){d++;for(var n=i.lines;n;n--){var s=Math.max(1-(d+n*b)%p*f,i.opacity);e.opacity(o,i.lines-n,s,i)}e.timeout=e.el&&setTimeout(t,~~(1e3/u))}()}return e},stop:function(){var t=this.el;return t&&(clearTimeout(this.timeout),t.parentNode&&t.parentNode.removeChild(t),this.el=i),this},lines:function(t,e){function i(t,i){return a(n(),{position:"absolute",width:e.length+e.width+"px",height:e.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/e.lines*r+e.rotate)+"deg) translate("+e.radius+"px,0)",borderRadius:(e.width>>1)+"px"})}var r=0,l;for(;r<e.lines;r++)l=a(n(),{position:"absolute",top:1+~(e.width/2)+"px",transform:e.hwaccel?"translate3d(0,0,0)":"",opacity:e.opacity,animation:h&&s(e.opacity,e.trail,r,e.lines)+" "+1/e.speed+"s linear infinite"}),e.shadow&&o(l,a(i("#000","0 0 4px #000"),{top:"2px"})),o(t,o(l,i(e.color,"0 0 1px rgba(0,0,0,.1)")));return t},opacity:function(t,e,i){e<t.childNodes.length&&(t.childNodes[e].style.opacity=i)}}),!function(){function t(t,e){return n("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',e)}var e=a(n("group"),{behavior:"url(#default#VML)"});!r(e,"transform")&&e.adj?(p.addRule(".spin-vml","behavior:url(#default#VML)"),b.prototype.lines=function(e,i){function n(){return a(t("group",{coordsize:l+" "+l,coordorigin:-r+" "+-r}),{width:l,height:l})}function s(e,s,l){o(d,o(a(n(),{rotation:360/i.lines*e+"deg",left:~~s}),o(a(t("roundrect",{arcsize:1}),{width:r,height:i.width,left:i.radius,top:-i.width>>1,filter:l}),t("fill",{color:i.color,opacity:i.opacity}),t("stroke",{opacity:0}))))}var r=i.length+i.width,l=2*r,c=2*-(i.width+i.length)+"px",d=a(n(),{position:"absolute",top:c,left:c}),u;if(i.shadow)for(u=1;u<=i.lines;u++)s(u,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(u=1;u<=i.lines;u++)s(u);return o(e,d)},b.prototype.opacity=function(t,e,i,n){var o=t.firstChild;n=n.shadow&&n.lines||0,o&&e+n<o.childNodes.length&&(o=o.childNodes[e+n],o=o&&o.firstChild,o=o&&o.firstChild,o&&(o.opacity=i))}):h=r(e,"animation")}(),t.Spinner=b})(window,document);o.editorStore=function(t,i,n){var s;n=n||{};switch(i){case"create":var r=e.trim(t.$el.val());t.dataStore={data:[]};if(r.length>0)try{var a=JSON.parse(r);e.isUndefined(a.data)||(t.dataStore=a)}catch(e){t.errors.push({text:i18n.t("errors:load_fail")});t.renderErrors();o.log("Sorry there has been a problem with parsing the JSON");o.log(e)}break;case"reset":t.dataStore={data:[]};break;case"add":if(n.data){t.dataStore.data.push(n.data);s=t.dataStore}break;case"save":t.$el.val(t.dataStore.data.length>0?JSON.stringify(t.dataStore):"");break;case"read":s=t.dataStore;break}if(s)return s};o.Submittable=function(t){this.$form=t;this.intialize()};e.extend(o.Submittable.prototype,{intialize:function(){this.$submitBtn=this.$form.find("input[type='submit']");var i=[];e.each(this.$submitBtn,(function(e){i.push(t(e).attr("value"))}));this.submitBtnTitles=i;this.canSubmit=true;this.globalUploadCount=0;this._bindEvents()},setSubmitButton:function(t,e){this.$submitBtn.attr("value",e)},resetSubmitButton:function(){e.each(this.$submitBtn,(function(e,i){t(e).attr("value",this.submitBtnTitles[i])}),this)},onUploadStart:function(t){this.globalUploadCount++;o.log("onUploadStart called "+this.globalUploadCount);1===this.globalUploadCount&&this._disableSubmitButton()},onUploadStop:function(t){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1;o.log("onUploadStop called "+this.globalUploadCount);0===this.globalUploadCount&&this._enableSubmitButton()},onError:function(t){o.log("onError called");this.canSubmit=false},_disableSubmitButton:function(t){this.setSubmitButton(null,t||i18n.t("general:wait"));this.$submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton();this.$submitBtn.removeAttr("disabled").removeClass("disabled")},_events:{disableSubmitButton:"_disableSubmitButton",enableSubmitButton:"_enableSubmitButton",setSubmitButton:"setSubmitButton",resetSubmitButton:"resetSubmitButton",onError:"onError",onUploadStart:"onUploadStart",onUploadStop:"onUploadStop"},_bindEvents:function(){e.forEach(this._events,(function(t,e){o.EventBus.on(e,this[t],this)}),this)}});o.fileUploader=function(i,n,s,r){var a=[i.blockID,(new Date).getTime(),"raw"].join("-");var l=new FormData;l.append("attachment[name]",n.name);l.append("attachment[file]",n);l.append("attachment[uid]",a);i.resetMessages();var c=function(t){o.log("Upload callback called");!e.isUndefined(s)&&e.isFunction(s)&&e.bind(s,i)(t)};var d=function(t,n,s){o.log("Upload callback error called");!e.isUndefined(r)&&e.isFunction(r)&&e.bind(r,i)(n)};var u=t.ajax({url:o.DEFAULTS.uploadUrl,data:l,cache:false,contentType:false,processData:false,dataType:"json",type:"POST"});i.addQueuedItem(a,u);u.done(c).fail(d).always(e.bind(i.removeQueuedItem,i,a));return u};var h=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;e.mixin({isURI:function(t){return h.test(t)},titleize:function(t){if(null===t)return"";t=String(t).toLowerCase();return t.replace(/(?:^|\s|-)\S/g,(function(t){return t.toUpperCase()}))},classify:function(t){return e.titleize(String(t).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(t){return e.map(t,(function(t){return e.classify(t)}))},capitalize:function(t){return t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},underscored:function(t){return e.trim(t).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(t){return t.split("").reverse().join("")},flattern:function(t){var i={};e.each(t,(function(n,o){i[e.isArray(t)?n:o]=true}));return i},to_slug:function(t){return t.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}});o.toHTML=function(t,i){i=e.classify(i);var n=t,s="Text"===i;e.isUndefined(s)&&(s=false);s&&(n="<div>"+n);n=n.replace(/^\> (.+)$/gm,"$1");var r,a;for(r in o.Formatters)if(o.Formatters.hasOwnProperty(r)){a=o.Formatters[r];!e.isUndefined(a.toHTML)&&e.isFunction(a.toHTML)&&(n=a.toHTML(n))}var l;if(o.Blocks.hasOwnProperty(i)){l=o.Blocks[i];!e.isUndefined(l.prototype.toHTML)&&e.isFunction(l.prototype.toHTML)&&(n=l.prototype.toHTML(n))}if(s){n=n.replace(/\n\n/gm,"</div><div><br></div><div>");n=n.replace(/\n/gm,"</div><div>")}n=n.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\n/g,"<br>").replace(/\*\*/,"").replace(/__/,"");n=n.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\~/g,"~").replace(/\\\-/g,"-");s&&(n+="</div>");return n};o.toMarkdown=function(t,i){i=e.classify(i);var n=t;n=n.replace(/( class=(")?Mso[a-zA-Z]+(")?)/g,"").replace(/<!--(.*?)-->/g,"").replace(/\/\*(.*?)\*\//g,"").replace(/<(\/)*(meta|link|\\?xml:|st1:|o:)(.*?)>/gi,"");var s=["style","script","applet","embed","noframes","noscript"],r,a;for(a=0;a<s.length;a++){r=new RegExp("<"+s[a]+".*?"+s[a]+"(.*?)>","gi");n=n.replace(r,"")}n=n.replace(/\*/g,"\\*").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\_/g,"\\_").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\~/g,"\\~").replace(/\-/g,"\\-");function l(t,i,n){e.isUndefined(n)&&(n="");return"**"+i.replace(/<(.)?br(.)?>/g,"")+"**"+n}function c(t,i,n){e.isUndefined(n)&&(n="");return"_"+i.replace(/<(.)?br(.)?>/g,"")+"_"+n}n=n.replace(/\u200b/g,"").replace(/<(\w+)(?:\s+\w+="[^"]+(?:"\$[^"]+"[^"]+)?")*>\s*<\/\1>/gim,"").replace(/\n/gm,"");var d,u;for(d in o.Formatters)if(o.Formatters.hasOwnProperty(d)){u=o.Formatters[d];!e.isUndefined(u.toMarkdown)&&e.isFunction(u.toMarkdown)&&(n=u.toMarkdown(n))}n=n.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>(?!$)/g,"\n").replace(/<(.)?br(.)?>/g,"\n");n=n.replace(/&nbsp;/g," ");var h;if(o.Blocks.hasOwnProperty(i)){h=o.Blocks[i];!e.isUndefined(h.prototype.toMarkdown)&&e.isFunction(h.prototype.toMarkdown)&&(n=h.prototype.toMarkdown(n))}n=n.replace(/<\/?[^>]+(>|$)/g,"");return n};o.EventBus=e.extend({},o.Events);o.BlockMixins.Ajaxable={mixinName:"Ajaxable",ajaxable:true,initializeAjaxable:function(){this._queued=[]},addQueuedItem:function(t,e){o.log("Adding queued item for "+this.blockID+" called "+t);o.EventBus.trigger("onUploadStart");this._queued.push({name:t,deffered:e})},removeQueuedItem:function(t){o.log("Removing queued item for "+this.blockID+" called "+t);o.EventBus.trigger("onUploadStop");this._queued=e.reject(this._queued,(function(e){return e.name==t}))},hasItemsInQueue:function(){return this._queued.length>0},resolveAllInQueue:function(){e.each(this._queued,(function(t){o.log("Aborting queued request: "+t.name);t.deffered.abort()}),this)}};o.BlockMixins.Controllable={mixinName:"Controllable",initializeControllable:function(){o.log("Adding controllable to block "+this.blockID);this.$control_ui=t("<div>",{class:"st-block__control-ui"});e.each(this.controls,(function(t,i){this.addUiControl(i,e.bind(t,this))}),this);this.$inner.append(this.$control_ui)},getControlTemplate:function(e){return t("<a>",{"data-icon":e,class:"st-icon st-block-control-ui-btn st-block-control-ui-btn--"+e})},addUiControl:function(t,e){this.$control_ui.append(this.getControlTemplate(t));this.$control_ui.on("click",".st-block-control-ui-btn--"+t,e)}};o.BlockMixins.Droppable={mixinName:"Droppable",valid_drop_file_types:["File","Files","text/plain","text/uri-list"],initializeDroppable:function(){o.log("Adding droppable to block "+this.blockID);this.drop_options=e.extend({},o.DEFAULTS.Block.drop_options,this.drop_options);var i=t(e.template(this.drop_options.html,{block:this}));this.$editor.hide();this.$inputs.append(i);this.$dropzone=i;this.$dropzone.dropArea().bind("drop",e.bind(this._handleDrop,this));this.$inner.addClass("st-block__inner--droppable")},_handleDrop:function(i){i.preventDefault();i=i.originalEvent;var n=t(i.target),s=i.dataTransfer.types,r,a=[];n.removeClass("st-dropzone--dragover");!e.isUndefined(s)&&e.some(s,(function(t){return e.include(this.valid_drop_file_types,t)}),this)&&this.onDrop(i.dataTransfer);o.EventBus.trigger("block:content:dropped")}};o.BlockMixins.Fetchable={mixinName:"Fetchable",initializeFetchable:function(){this.withMixin(o.BlockMixins.Ajaxable)},fetch:function(i,n,o){var s=e.uniqueId(this.blockID+"_fetch"),r=t.ajax(i);this.resetMessages();this.addQueuedItem(s,r);e.isUndefined(n)||r.done(e.bind(n,this));e.isUndefined(o)||r.fail(e.bind(o,this));r.always(e.bind(this.removeQueuedItem,this,s));return r}};o.BlockMixins.Pastable={mixinName:"Pastable",initializePastable:function(){o.log("Adding pastable to block "+this.blockID);this.paste_options=e.extend({},o.DEFAULTS.Block.paste_options,this.paste_options);this.$inputs.append(e.template(this.paste_options.html,this));this.$(".st-paste-block").bind("click",(function(){t(this).select()})).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}};o.BlockMixins.Uploadable={mixinName:"Uploadable",uploadsCount:0,initializeUploadable:function(){o.log("Adding uploadable to block "+this.blockID);this.withMixin(o.BlockMixins.Ajaxable);this.upload_options=e.extend({},o.DEFAULTS.Block.upload_options,this.upload_options);this.$inputs.append(e.template(this.upload_options.html,this))},uploader:function(t,e,i){return o.fileUploader(this,t,e,i)}};o.BlockPositioner=function(){var t=["<div class='st-block-positioner__inner'>","<span class='st-block-positioner__selected-value'></span>","<select class='st-block-positioner__select'></select>","</div>"].join("\n");var i=function(t,e){this.$block=t;this.instanceID=e;this.total_blocks=0;this._ensureElement();this._bindFunctions();this.initialize()};e.extend(i.prototype,l,c,{bound:["onBlockCountChange","onSelectChange","toggle","show","hide"],className:"st-block-positioner",visibleClass:"st-block-positioner--is-visible",initialize:function(){this.$el.append(t);this.$select=this.$(".st-block-positioner__select");this.$select.on("change",this.onSelectChange);o.EventBus.on(this.instanceID+":blocks:count_update",this.onBlockCountChange)},onBlockCountChange:function(t){if(t!=this.total_blocks){this.total_blocks=t;this.renderPositionList()}},onSelectChange:function(){var t=this.$select.val();if(0!==t){o.EventBus.trigger(this.instanceID+":blocks:change_position",this.$block,t,1==t?"before":"after");this.toggle()}},renderPositionList:function(){var t="<option value='0'>"+i18n.t("general:position")+"</option>";for(var e=1;e<=this.total_blocks;e++)t+="<option value="+e+">"+e+"</option>";this.$select.html(t)},toggle:function(){this.$select.val(0);this.$el.toggleClass(this.visibleClass)},show:function(){this.$el.addClass(this.visibleClass)},hide:function(){this.$el.removeClass(this.visibleClass)}});return i}();o.BlockReorder=function(){var i=function(t){this.$block=t;this._ensureElement();this._bindFunctions();this.initialize()};e.extend(i.prototype,l,c,{bound:["onMouseDown","onClick","onDragStart","onDragEnd","onDrag","onDrop"],className:"st-block-ui-btn st-block-ui-btn--reorder st-icon",tagName:"a",attributes:function(){return{html:"reorder",draggable:"true","data-icon":"move"}},initialize:function(){this.$el.bind("mousedown touchstart",this.onMouseDown).bind("click",this.onClick).bind("dragstart",this.onDragStart).bind("dragend touchend",this.onDragEnd).bind("drag touchmove",this.onDrag);this.$block.dropArea().bind("drop",this.onDrop)},onMouseDown:function(){o.EventBus.trigger("block:reorder:down")},onDrop:function(i){i.preventDefault();var n=this.$block,s=i.originalEvent.dataTransfer.getData("text/plain"),r=t("#"+s);e.isUndefined(s)||e.isEmpty(r)||n.attr("id")==s||n.attr("data-instance")!=r.attr("data-instance")||n.after(r);o.EventBus.trigger("block:reorder:dropped",s)},onDragStart:function(e){var i=t(e.currentTarget).parent();e.originalEvent.dataTransfer.setDragImage(this.$block[0],i.position().left,i.position().top);e.originalEvent.dataTransfer.setData("Text",this.$block.attr("id"));o.EventBus.trigger("block:reorder:dragstart");this.$block.addClass("st-block--dragging")},onDragEnd:function(t){o.EventBus.trigger("block:reorder:dragend");this.$block.removeClass("st-block--dragging")},onDrag:function(t){},onClick:function(){},render:function(){return this}});return i}();o.BlockDeletion=function(){var t=function(){this._ensureElement();this._bindFunctions()};e.extend(t.prototype,l,c,{tagName:"a",className:"st-block-ui-btn st-block-ui-btn--delete st-icon",attributes:{html:"delete","data-icon":"bin"}});return t}();var p=function(t){var i=t.attr("data-st-name")||t.attr("name");i||(i="Field");return e.capitalize(i)};o.BlockValidations={errors:[],valid:function(){this.performValidations();return 0===this.errors.length},performValidations:function(){this.resetErrors();var t=this.$(".st-required");e.each(t,this.validateField,this);e.each(this.validations,this.runValidator,this);this.$el.toggleClass("st-block--with-errors",this.errors.length>0)},validations:[],validateField:function(e){e=t(e);var i=e.attr("contenteditable")?e.text():e.val();0===i.length&&this.setError(e,i18n.t("errors:block_empty",{name:p(e)}))},runValidator:function(t){e.isUndefined(this[t])||this[t].call(this)},setError:function(t,e){var i=this.addMessage(e,"st-msg--error");t.addClass("st-error");this.errors.push({field:t,reason:e,msg:i})},resetErrors:function(){e.each(this.errors,(function(t){t.field.removeClass("st-error");t.msg.remove()}));this.$messages.removeClass("st-block__messages--is-visible");this.errors=[]}};o.BlockStore={blockStorage:{},createStore:function(t){this.blockStorage={type:e.underscored(this.type),data:t||{}}},save:function(){this.toData()},saveAndReturnData:function(){this.save();return this.blockStorage},saveAndGetData:function(){var t=this.saveAndReturnData();return t.data||t},getData:function(){return this.blockStorage.data},setData:function(t){o.log("Setting data for block "+this.blockID);e.extend(this.blockStorage.data,t||{})},setAndRetrieveData:function(t){this.setData(t);return this.getData()},setAndLoadData:function(t){this.setData(t);this.beforeLoadingData()},toData:function(){},loadData:function(){},beforeLoadingData:function(){o.log("loadData for "+this.blockID);o.EventBus.trigger("editor/block/loadData");this.loadData(this.getData())},_loadData:function(){o.log("_loadData is deprecated and will be removed in the future. Please use beforeLoadingData instead.");this.beforeLoadingData()},checkAndLoadData:function(){e.isEmpty(this.getData())||this.beforeLoadingData()}};o.SimpleBlock=function(){var i=function(t,i){this.createStore(t);this.blockID=e.uniqueId("st-block-");this.instanceID=i;this._ensureElement();this._bindFunctions();this.initialize.apply(this,arguments)};e.extend(i.prototype,l,o.Events,c,o.BlockStore,{focus:function(){},valid:function(){return true},className:"st-block",block_template:e.template("<div class='st-block__inner'><%= editor_html %></div>"),attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID}},title:function(){return e.titleize(this.type.replace(/[\W_]/g," "))},blockCSSClass:function(){this.blockCSSClass=e.to_slug(this.type);return this.blockCSSClass},type:"",class:function(){return e.classify(this.type)},editorHTML:"",initialize:function(){},onBlockRender:function(){},beforeBlockRender:function(){},_setBlockInner:function(){var t=e.result(this,"editorHTML");this.$el.append(this.block_template({editor_html:t}));this.$inner=this.$el.find(".st-block__inner");this.$inner.bind("click mouseover",(function(t){t.stopPropagation()}))},render:function(){this.beforeBlockRender();this._setBlockInner();this._blockPrepare();return this},_blockPrepare:function(){this._initUI();this._initMessages();this.checkAndLoadData();this.$el.addClass("st-item-ready");this.on("onRender",this.onBlockRender);this.save()},_withUIComponent:function(t,e,i){this.$ui.append(t.render().$el);e&&i&&this.$ui.on("click",e,i)},_initUI:function(){var e=t("<div>",{class:"st-block__ui"});this.$inner.append(e);this.$ui=e;this._initUIComponents()},_initMessages:function(){var e=t("<div>",{class:"st-block__messages"});this.$inner.prepend(e);this.$messages=e},addMessage:function(e,i){var n=t("<span>",{html:e,class:"st-msg "+i});this.$messages.append(n).addClass("st-block__messages--is-visible");return n},resetMessages:function(){this.$messages.html("").removeClass("st-block__messages--is-visible")},_initUIComponents:function(){this._withUIComponent(new o.BlockReorder(this.$el))}});i.fn=i.prototype;i.extend=u;return i}();o.Block=function(){var i=function(t,e){o.SimpleBlock.apply(this,arguments)};var n=["<div class='st-block__ui-delete-controls'>","<label class='st-block__delete-label'>","<%= i18n.t('general:delete') %>","</label>","<a class='st-block-ui-btn st-block-ui-btn--confirm-delete st-icon' data-icon='tick'></a>","<a class='st-block-ui-btn st-block-ui-btn--deny-delete st-icon' data-icon='close'></a>","</div>"].join("\n");var s={html:['<div class="st-block__dropzone">','<span class="st-icon"><%= _.result(block, "icon_name") %></span>','<p><%= i18n.t("general:drop", { block: "<span>" + _.result(block, "title") + "</span>" }) %>',"</p></div>"].join("\n"),re_render_on_reorder:false};var r={html:['<input type="text" placeholder="<%= i18n.t("general:paste") %>"',' class="st-block__paste-input st-paste-block">'].join("")};var a={html:['<div class="st-block__upload-container">','<input type="file" type="st-file-upload">','<button class="st-upload-btn"><%= i18n.t("general:upload") %></button>',"</div>"].join("\n")};o.DEFAULTS.Block={drop_options:s,paste_options:r,upload_options:a};e.extend(i.prototype,o.SimpleBlock.fn,o.BlockValidations,{bound:["_handleContentPaste","_onFocus","_onBlur","onDrop","onDeleteClick","clearInsertedStyles","getSelectionForFormatter","onBlockRender"],className:"st-block st-icon--add",attributes:function(){return e.extend(o.SimpleBlock.fn.attributes.call(this),{"data-icon-after":"add"})},icon_name:"default",validationFailMsg:function(){return i18n.t("errors:validation_fail",{type:this.title()})},editorHTML:'<div class="st-block__editor"></div>',toolbarEnabled:true,droppable:false,pastable:false,uploadable:false,fetchable:false,ajaxable:false,drop_options:{},paste_options:{},upload_options:{},formattable:true,_previousSelection:"",initialize:function(){},toMarkdown:function(t){return t},toHTML:function(t){return t},withMixin:function(t){if(!e.isObject(t))return;var i="initialize"+t.mixinName;if(e.isUndefined(this[i])){e.extend(this,t);this[i]()}},render:function(){this.beforeBlockRender();this._setBlockInner();this.$editor=this.$inner.children().first();if(this.droppable||this.pastable||this.uploadable){var e=t("<div>",{class:"st-block__inputs"});this.$inner.append(e);this.$inputs=e}this.hasTextBlock&&this._initTextBlocks();this.droppable&&this.withMixin(o.BlockMixins.Droppable);this.pastable&&this.withMixin(o.BlockMixins.Pastable);this.uploadable&&this.withMixin(o.BlockMixins.Uploadable);this.fetchable&&this.withMixin(o.BlockMixins.Fetchable);this.controllable&&this.withMixin(o.BlockMixins.Controllable);this.formattable&&this._initFormatting();this._blockPrepare();return this},remove:function(){this.ajaxable&&this.resolveAllInQueue();this.$el.remove()},loading:function(){e.isUndefined(this.spinner)||this.ready();this.spinner=new Spinner(o.DEFAULTS.spinner);this.spinner.spin(this.$el[0]);this.$el.addClass("st--is-loading")},ready:function(){this.$el.removeClass("st--is-loading");if(!e.isUndefined(this.spinner)){this.spinner.stop();delete this.spinner}},toData:function(){o.log("toData for "+this.blockID);var t=this.$el,i={};if(this.hasTextBlock()){var n=this.getTextBlock().html();n.length>0&&(i.text=o.toMarkdown(n,this.type))}this.$(":input").not(".st-paste-block").length>0&&this.$(":input").each((function(t,e){e.getAttribute("name")&&(i[e.getAttribute("name")]=e.value)}));e.isEmpty(i)||this.setData(i)},focus:function(){this.getTextBlock().focus()},blur:function(){this.getTextBlock().blur()},onFocus:function(){this.getTextBlock().bind("focus",this._onFocus)},onBlur:function(){this.getTextBlock().bind("blur",this._onBlur)},_onFocus:function(){this.trigger("blockFocus",this.$el)},_onBlur:function(){},onDrop:function(t){},onDeleteClick:function(t){t.preventDefault();var i=function(t){t.preventDefault();this.trigger("removeBlock",this.blockID)};var o=function(t){t.preventDefault();this.$el.removeClass("st-block--delete-active");s.remove()};if(this.isEmpty()){i.call(this,new Event("click"));return}this.$inner.append(e.template(n));this.$el.addClass("st-block--delete-active");var s=this.$inner.find(".st-block__ui-delete-controls");this.$inner.on("click",".st-block-ui-btn--confirm-delete",e.bind(i,this)).on("click",".st-block-ui-btn--deny-delete",e.bind(o,this))},pastedMarkdownToHTML:function(t){return o.toHTML(o.toMarkdown(t,this.type),this.type)},onContentPasted:function(t,e){e.html(this.pastedMarkdownToHTML(e[0].innerHTML));this.getTextBlock().caretToEnd()},beforeLoadingData:function(){this.loading();if(this.droppable||this.uploadable||this.pastable){this.$editor.show();this.$inputs.hide()}o.SimpleBlock.fn.beforeLoadingData.call(this);this.ready()},_handleContentPaste:function(i){var n=t(i.currentTarget);e.delay(e.bind(this.onContentPasted,this,i,n),0)},_getBlockClass:function(){return"st-block--"+this.className},_initUIComponents:function(){var t=new o.BlockPositioner(this.$el,this.instanceID);this._withUIComponent(t,".st-block-ui-btn--reorder",t.toggle);this._withUIComponent(new o.BlockReorder(this.$el));this._withUIComponent(new o.BlockDeletion,".st-block-ui-btn--delete",this.onDeleteClick);this.onFocus();this.onBlur()},_initFormatting:function(){var t;for(var i in o.Formatters)if(o.Formatters.hasOwnProperty(i)){t=o.Formatters[i];e.isUndefined(t.keyCode)||t._bindToBlock(this.$el)}},_initTextBlocks:function(){this.getTextBlock().bind("paste",this._handleContentPaste).bind("keyup",this.getSelectionForFormatter).bind("mouseup",this.getSelectionForFormatter).bind("DOMNodeInserted",this.clearInsertedStyles)},getSelectionForFormatter:function(){e.defer((function(){var t=window.getSelection(),e=t.toString().trim();""===e?o.EventBus.trigger("formatter:hide"):o.EventBus.trigger("formatter:positon")}))},clearInsertedStyles:function(t){var e=t.target;e.removeAttribute("style")},hasTextBlock:function(){return this.getTextBlock().length>0},getTextBlock:function(){e.isUndefined(this.text_block)&&(this.text_block=this.$(".st-text-block"));return this.text_block},isEmpty:function(){return e.isEmpty(this.saveAndGetData())}});i.extend=u;return i}();o.Formatter=function(){var t=function(t){this.formatId=e.uniqueId("format-");this._configure(t||{});this.initialize.apply(this,arguments)};var i=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];e.extend(t.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(t){return t},toHTML:function(t){return t},initialize:function(){},_configure:function(t){this.options&&(t=e.extend({},this.options,t));for(var n=0,o=i.length;n<o;n++){var s=i[n];t[s]&&(this[s]=t[s])}this.options=t},isActive:function(){return document.queryCommandState(this.cmd)},_bindToBlock:function(t){var e=this,i=false;t.on("keyup",".st-text-block",(function(t){17!=t.which&&224!=t.which&&91!=t.which||(i=false)})).on("keydown",".st-text-block",{formatter:e},(function(t){17!=t.which&&224!=t.which&&91!=t.which||(i=true);if(t.which==t.data.formatter.keyCode&&true===i){document.execCommand(t.data.formatter.cmd,false,true);t.preventDefault();i=false}}))}});t.extend=u;return t}();o.Blocks.Quote=function(){var t=e.template(['<blockquote class="st-required st-text-block" contenteditable="true"></blockquote>','<label class="st-input-label"> <%= i18n.t("blocks:quote:credit_field") %></label>','<input maxlength="140" name="cite" placeholder="<%= i18n.t("blocks:quote:credit_field") %>"',' class="st-input-string st-required js-cite-input" type="text" />'].join("\n"));return o.Block.extend({type:"quote",title:function(){return i18n.t("blocks:quote:title")},icon_name:"quote",editorHTML:function(){return t(this)},loadData:function(t){this.getTextBlock().html(o.toHTML(t.text,this.type));this.$(".js-cite-input").val(t.cite)},toMarkdown:function(t){return t.replace(/^(.+)$/gm,"> $1")}})}();o.Blocks.Heading=o.Block.extend({type:"Heading",title:function(){return i18n.t("blocks:heading:title")},editorHTML:'<div class="st-required st-text-block st-text-block--heading" contenteditable="true"></div>',icon_name:"heading",loadData:function(t){this.getTextBlock().html(o.toHTML(t.text,this.type))}});o.Blocks.Image=o.Block.extend({type:"image",title:function(){return i18n.t("blocks:image:title")},droppable:true,uploadable:true,icon_name:"image",loadData:function(e){this.$editor.html(t("<img>",{src:e.file.url}))},onBlockRender:function(){this.$inputs.find("button").bind("click",(function(t){t.preventDefault()}));this.$inputs.find("input").on("change",e.bind((function(t){this.onDrop(t.currentTarget)}),this))},onDrop:function(e){var i=e.files[0],n="undefined"!==typeof URL?URL:"undefined"!==typeof webkitURL?webkitURL:null;if(/image/.test(i.type)){this.loading();this.$inputs.hide();this.$editor.html(t("<img>",{src:n.createObjectURL(i)})).show();this.uploader(i,(function(t){this.setData(t);this.ready()}),(function(t){this.addMessage(i18n.t("blocks:image:upload_error"));this.ready()}))}}});o.Blocks.Text=o.Block.extend({type:"text",title:function(){return i18n.t("blocks:text:title")},editorHTML:'<div class="st-required st-text-block" contenteditable="true"></div>',icon_name:"text",loadData:function(t){this.getTextBlock().html(o.toHTML(t.text,this.type))}});o.Blocks.List=function(){var t='<div class="st-text-block st-required" contenteditable="true"><ul><li></li></ul></div>';return o.Block.extend({type:"list",title:function(){return i18n.t("blocks:list:title")},icon_name:"list",editorHTML:function(){return e.template(t,this)},loadData:function(t){this.getTextBlock().html("<ul>"+o.toHTML(t.text,this.type)+"</ul>")},onBlockRender:function(){this.checkForList=e.bind(this.checkForList,this);this.getTextBlock().on("click keyup",this.checkForList)},checkForList:function(){0===this.$("ul").length&&document.execCommand("insertUnorderedList",false,false)},toMarkdown:function(t){return t.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")},toHTML:function(t){t=t.replace(/^ - (.+)$/gm,"<li>$1</li>").replace(/\n/gm,"");return t},onContentPasted:function(t,e){var i=this.pastedMarkdownToHTML(e[0].innerHTML),n=this.$("ul").html(i);this.getTextBlock().caretToEnd()},isEmpty:function(){return e.isEmpty(this.saveAndGetData().text)}})}();o.Blocks.Video=function(){return o.Block.extend({providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:'<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>'},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:'<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" width="580" height="320" frameborder="0" allowfullscreen></iframe>'}},type:"video",title:function(){return i18n.t("blocks:video:title")},droppable:true,pastable:true,icon_name:"video",loadData:function(t){if(!this.providers.hasOwnProperty(t.source))return;this.providers[t.source].square?this.$editor.addClass("st-block__editor--with-square-media"):this.$editor.addClass("st-block__editor--with-sixteen-by-nine-media");var e=this.providers[t.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",t.remote_id).replace("{{width}}",this.$editor.width());this.$editor.html(e)},onContentPasted:function(e){this.handleDropPaste(t(e.target).val())},handleDropPaste:function(t){if(!e.isURI(t))return;var i,n;e.each(this.providers,(function(o,s){i=o.regex.exec(t);if(null!==i&&!e.isUndefined(i[1])){n={source:s,remote_id:i[1]};this.setAndLoadData(n)}}),this)},onDrop:function(t){var e=t.getData("text/plain");this.handleDropPaste(e)}})}();(function(){var t=o.Formatter.extend({title:"bold",cmd:"bold",keyCode:66,text:"B"});var e=o.Formatter.extend({title:"italic",cmd:"italic",keyCode:73,text:"i"});var i=o.Formatter.extend({title:"link",iconName:"link",cmd:"CreateLink",text:"link",onClick:function(){var t=prompt(i18n.t("general:link")),e=/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/;if(t&&t.length>0){e.test(t)||(t="http://"+t);document.execCommand(this.cmd,false,t)}},isActive:function(){var t=window.getSelection(),e;t.rangeCount>0&&(e=t.getRangeAt(0).startContainer.parentNode);return e&&"A"==e.nodeName}});var n=o.Formatter.extend({title:"unlink",iconName:"link",cmd:"unlink",text:"link"});o.Formatters.Bold=new t;o.Formatters.Italic=new e;o.Formatters.Link=new i;o.Formatters.Unlink=new n})();o.BlockControl=function(){var t=function(t,e){this.type=t;this.instance_scope=e;this.block_type=o.Blocks[this.type].prototype;this.can_be_rendered=this.block_type.toolbarEnabled;this._ensureElement()};e.extend(t.prototype,l,c,o.Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.block_type.type}},render:function(){this.$el.html('<span class="st-icon">'+e.result(this.block_type,"icon_name")+"</span>"+e.result(this.block_type,"title"));return this}});return t}();o.BlockControls=function(){var i=function(t,e){this.instance_scope=e;this.available_types=t||[];this._ensureElement();this._bindFunctions();this.initialize()};e.extend(i.prototype,l,c,o.Events,{bound:["handleControlButtonClick"],block_controls:null,className:"st-block-controls",html:"<a class='st-icon st-icon--close'>"+i18n.t("general:close")+"</a>",initialize:function(){for(var t in this.available_types)if(o.Blocks.hasOwnProperty(t)){var e=new o.BlockControl(t,this.instance_scope);e.can_be_rendered&&this.$el.append(e.render().$el)}this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},show:function(){this.$el.addClass("st-block-controls--active");o.EventBus.trigger("block:controls:shown")},hide:function(){this.$el.removeClass("st-block-controls--active");o.EventBus.trigger("block:controls:hidden")},handleControlButtonClick:function(e){e.stopPropagation();this.trigger("createBlock",t(e.currentTarget).attr("data-type"))}});i.extend=u;return i}();o.FloatingBlockControls=function(){var i=function(t,e){this.$wrapper=t;this.instance_id=e;this._ensureElement();this._bindFunctions();this.initialize()};e.extend(i.prototype,l,c,o.Events,{className:"st-block-controls__top",attributes:function(){return{"data-icon":"add"}},bound:["handleBlockMouseOut","handleBlockMouseOver","handleBlockClick","onDrop"],initialize:function(){this.$el.on("click",this.handleBlockClick).dropArea().bind("drop",this.onDrop);this.$wrapper.on("mouseover",".st-block",this.handleBlockMouseOver).on("mouseout",".st-block",this.handleBlockMouseOut).on("click",".st-block--with-plus",this.handleBlockClick)},onDrop:function(i){i.preventDefault();var n=this.$el,s=i.originalEvent.dataTransfer.getData("text/plain"),r=t("#"+s);e.isUndefined(s)||e.isEmpty(r)||n.attr("id")==s||this.instance_id!=r.attr("data-instance")||n.after(r);o.EventBus.trigger("block:reorder:dropped",s)},handleBlockMouseOver:function(e){var i=t(e.currentTarget);i.hasClass("st-block--with-plus")||i.addClass("st-block--with-plus")},handleBlockMouseOut:function(e){var i=t(e.currentTarget);i.hasClass("st-block--with-plus")&&i.removeClass("st-block--with-plus")},handleBlockClick:function(e){e.stopPropagation();var i=t(e.currentTarget);this.trigger("showBlockControls",i)}});i.extend=u;return i}();o.FormatBar=function(){var i=function(t){this.options=e.extend({},o.DEFAULTS.formatBar,t||{});this._ensureElement();this._bindFunctions();this.initialize.apply(this,arguments)};e.extend(i.prototype,l,o.Events,c,{className:"st-format-bar",bound:["onFormatButtonClick","renderBySelection","hide"],initialize:function(){var e,i,n;this.$btns=[];for(e in o.Formatters)if(o.Formatters.hasOwnProperty(e)){i=o.Formatters[e];n=t("<button>",{class:"st-format-btn st-format-btn--"+e+" "+(i.iconName?"st-icon":""),text:i.text,"data-type":e,"data-cmd":i.cmd});this.$btns.push(n);n.appendTo(this.$el)}this.$b=t(document);this.$el.bind("click",".st-format-btn",this.onFormatButtonClick)},hide:function(){this.$el.removeClass("st-format-bar--is-ready")},show:function(){this.$el.addClass("st-format-bar--is-ready")},remove:function(){this.$el.remove()},renderBySelection:function(t){var e=window.getSelection(),i=e.getRangeAt(0),n=i.getBoundingClientRect(),o={};o.top=n.top+20+window.pageYOffset-this.$el.height()+"px";o.left=(n.left+n.right)/2-this.$el.width()/2+"px";this.highlightSelectedButtons();this.show();this.$el.css(o)},highlightSelectedButtons:function(){var t;e.each(this.$btns,(function(e){t=o.Formatters[e.attr("data-type")];e.toggleClass("st-format-btn--is-active",t.isActive())}),this)},onFormatButtonClick:function(i){i.stopPropagation();var n=t(i.target),s=o.Formatters[n.attr("data-type")];if(e.isUndefined(s))return false;!e.isUndefined(s.onClick)&&e.isFunction(s.onClick)?s.onClick():document.execCommand(n.attr("data-cmd"),false,s.param);this.highlightSelectedButtons();return false}});i.extend=u;return i}();o.Editor=function(){var i=function(t){this.initialize(t)};e.extend(i.prototype,l,o.Events,{bound:["onFormSubmit","showBlockControls","hideAllTheThings","hideBlockControls","onNewBlockCreated","changeBlockPosition","onBlockDragStart","onBlockDragEnd","removeBlockDragOver","onBlockDropped","createBlock"],events:{"block:reorder:down":"hideBlockControls","block:reorder:dragstart":"onBlockDragStart","block:reorder:dragend":"onBlockDragEnd","block:content:dropped":"removeBlockDragOver","block:reorder:dropped":"onBlockDropped","block:create:new":"onNewBlockCreated"},initialize:function(t){o.log("Init SirTrevor.Editor");this.blockTypes={};this.blockCounts={};this.blocks=[];this.errors=[];this.options=e.extend({},o.DEFAULTS,t||{});this.ID=e.uniqueId("st-editor-");if(!this._ensureAndSetElements())return false;!e.isUndefined(this.options.onEditorRender)&&e.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender);this._setRequired();this._setBlocksTypes();this._bindFunctions();this.store("create");this.build();o.instances.push(this);o.bindFormSubmit(this.$form)},build:function(){this.$el.hide();this.block_controls=new o.BlockControls(this.blockTypes,this.ID);this.fl_block_controls=new o.FloatingBlockControls(this.$wrapper,this.ID);this.formatBar=new o.FormatBar(this.options.formatBar);this.listenTo(this.block_controls,"createBlock",this.createBlock);this.listenTo(this.fl_block_controls,"showBlockControls",this.showBlockControls);this._setEvents();o.EventBus.on(this.ID+":blocks:change_position",this.changeBlockPosition);o.EventBus.on("formatter:positon",this.formatBar.renderBySelection);o.EventBus.on("formatter:hide",this.formatBar.hide);this.$wrapper.prepend(this.fl_block_controls.render().$el);t(document.body).append(this.formatBar.render().$el);this.$outer.append(this.block_controls.render().$el);t(window).bind("click",this.hideAllTheThings);var i=this.store("read");i.data.length>0?e.each(i.data,(function(t){o.log("Creating: "+t.type);this.createBlock(t.type,t.data)}),this):false!==this.options.defaultType&&this.createBlock(this.options.defaultType,{});this.$wrapper.addClass("st-ready");e.isUndefined(this.onEditorRender)||this.onEditorRender()},destroy:function(){this.formatBar.destroy();this.fl_block_controls.destroy();this.block_controls.destroy();e.each(this.blocks,(function(t){this.removeBlock(t.blockID)}),this);this.stopListening();var t=this.$el.detach();o.instances=e.reject(o.instances,e.bind((function(t){return t.ID==this.ID}),this));this.store("reset");this.$outer.replaceWith(t)},reinitialize:function(t){this.destroy();this.initialize(t||this.options)},_setEvents:function(){e.each(this.events,(function(t,e){o.EventBus.on(e,this[t],this)}),this)},hideAllTheThings:function(t){this.block_controls.hide();this.formatBar.hide();e.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls")},showBlockControls:function(t){e.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls");this.block_controls.show();t.append(this.block_controls.$el.detach());t.addClass("with-st-controls");this.block_controls.current_container=t},store:function(t,e){return o.editorStore(this,t,e||{})},createBlock:function(t,i,n){t=e.classify(t);if(this._blockLimitReached()){o.log("Cannot add any more blocks. Limit reached.");return false}if(!this._isBlockTypeAvailable(t)){o.log("Block type not available "+t);return false}if(!this._canAddBlockType(t)){o.log("Block Limit reached for type "+t);return false}var s=new o.Blocks[t](i,this.ID);this._renderInPosition(s.render().$el);this.listenTo(s,"removeBlock",this.removeBlock);this.blocks.push(s);this._incrementBlockTypeCount(t);s.focus();o.EventBus.trigger(i?"block:create:existing":"block:create:new",s);o.log("Block created of type "+t);s.trigger("onRender");this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached());this.triggerBlockCountUpdate()},onNewBlockCreated:function(t){this.hideBlockControls();this.scrollTo(t.$el)},scrollTo:function(e){t("html, body").animate({scrollTop:e.position().top},300,"linear")},blockFocus:function(t){this.block_controls.current_container=null},hideBlockControls:function(){e.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls");this.block_controls.hide()},removeBlockDragOver:function(){this.$outer.find(".st-drag-over").removeClass("st-drag-over")},triggerBlockCountUpdate:function(){o.EventBus.trigger(this.ID+":blocks:count_update",this.blocks.length)},changeBlockPosition:function(t,e){e-=1;var i=this.getBlockPosition(t);var n=this.$wrapper.find(".st-block").eq(e);var o=this.getBlockPosition(n);var s=i>e?"Before":"After";if(n&&n.attr("id")!==t.attr("id")){this.hideAllTheThings();t["insert"+s](n);this.scrollTo(t)}},onBlockDropped:function(t){this.hideAllTheThings();var i=this.findBlockById(t);e.isUndefined(i)||e.isEmpty(i.getData())||!i.drop_options.re_render_on_reorder||i.beforeLoadingData()},onBlockDragStart:function(){this.hideBlockControls();this.$wrapper.addClass("st-outer--is-reordering")},onBlockDragEnd:function(){this.removeBlockDragOver();this.$wrapper.removeClass("st-outer--is-reordering")},_renderInPosition:function(t){this.block_controls.current_container?this.block_controls.current_container.after(t):this.$wrapper.append(t)},_incrementBlockTypeCount:function(t){this.blockCounts[t]=e.isUndefined(this.blockCounts[t])?1:this.blockCounts[t]+1},_getBlockTypeCount:function(t){return e.isUndefined(this.blockCounts[t])?0:this.blockCounts[t]},_canAddBlockType:function(t){var e=this._getBlockTypeLimit(t);return!(0!==e&&this._getBlockTypeCount(t)>=e)},_blockLimitReached:function(){return 0!==this.options.blockLimit&&this.blocks.length>=this.options.blockLimit},removeBlock:function(t){var i=this.findBlockById(t),n=e.classify(i.type),s=i.$el.find(".st-block-controls");if(s.length){this.block_controls.hide();this.$wrapper.prepend(s)}this.blockCounts[n]=this.blockCounts[n]-1;this.blocks=e.reject(this.blocks,(function(t){return t.blockID==i.blockID}));this.stopListening(i);i.remove();o.EventBus.trigger("block:remove");this.triggerBlockCountUpdate();this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached())},performValidations:function(t,i){var n=0;if(!o.SKIP_VALIDATION&&i&&!t.valid()){this.errors.push({text:e.result(t,"validationFailMsg")});o.log("Block "+t.blockID+" failed validation");++n}return n},saveBlockStateToStore:function(t){var i=t.saveAndReturnData();if(i&&!e.isEmpty(i.data)){o.log("Adding data for block "+t.blockID+" to block store");this.store("add",{data:i})}},onFormSubmit:function(t){t=false!==t;o.log("Handling form submission for Editor "+this.ID);this.removeErrors();this.store("reset");this.validateBlocks(t);this.validateBlockTypesExist(t);this.renderErrors();this.store("save");return this.errors.length},validateBlocks:function(i){if(!this.required&&o.SKIP_VALIDATION&&!i)return false;var n=function(n,o){var s=e.find(this.blocks,(function(e){return e.blockID==t(n).attr("id")}));if(e.isUndefined(s))return false;this.performValidations(s,i);this.saveBlockStateToStore(s)};e.each(this.$wrapper.find(".st-block"),n,this)},validateBlockTypesExist:function(t){if(!this.required&&o.SKIP_VALIDATION&&!t)return false;var i=function(t,i){if(!this._isBlockTypeAvailable(t))return;if(0===this._getBlockTypeCount(t)){o.log("Failed validation on required block type "+t);this.errors.push({text:i18n.t("errors:type_missing",{type:t})})}else{var n=e.filter(this.getBlocksByType(t),(function(t){return!t.isEmpty()}));if(n.length>0)return false;this.errors.push({text:i18n.t("errors:required_type_empty",{type:t})});o.log("A required block type "+t+" is empty")}};e.isArray(this.required)&&e.each(this.required,i,this)},renderErrors:function(){if(0===this.errors.length)return false;e.isUndefined(this.$errors)&&(this.$errors=this._errorsContainer());var t="<ul>";e.each(this.errors,(function(e){t+='<li class="st-errors__msg">'+e.text+"</li>"}));t+="</ul>";this.$errors.append(t);this.$errors.show()},_errorsContainer:function(){if(e.isUndefined(this.options.errorsContainer)){var i=t("<div>",{class:"st-errors",html:"<p>"+i18n.t("errors:title")+" </p>"});this.$outer.prepend(i);return i}return r(this.options.errorsContainer)},removeErrors:function(){if(0===this.errors.length)return false;this.$errors.hide().find("ul").html("");this.errors=[]},findBlockById:function(t){return e.find(this.blocks,(function(e){return e.blockID==t}))},getBlocksByType:function(t){return e.filter(this.blocks,(function(i){return e.classify(i.type)==t}))},getBlocksByIDs:function(t){return e.filter(this.blocks,(function(i){return e.contains(t,i.blockID)}))},getBlockPosition:function(t){return this.$wrapper.find(".st-block").index(t)},_getBlockTypeLimit:function(t){if(!this._isBlockTypeAvailable(t))return 0;return parseInt(e.isUndefined(this.options.blockTypeLimits[t])?0:this.options.blockTypeLimits[t],10)},_isBlockTypeAvailable:function(t){return!e.isUndefined(this.blockTypes[t])},_ensureAndSetElements:function(){if(e.isUndefined(this.options.el)||e.isEmpty(this.options.el)){o.log("You must provide an el");return false}this.$el=this.options.el;this.el=this.options.el[0];this.$form=this.$el.parents("form");var i=t("<div>").attr({id:this.ID,class:"st-outer",dropzone:"copy link move"});var n=t("<div>").attr({class:"st-blocks"});this.$el.wrap(i).wrap(n);this.$outer=this.$form.find("#"+this.ID);this.$wrapper=this.$outer.find(".st-blocks");return true},_setBlocksTypes:function(){this.blockTypes=e.flattern(e.isUndefined(this.options.blockTypes)?o.Blocks:this.options.blockTypes)},_setRequired:function(){e.isArray(this.options.required)&&!e.isEmpty(this.options.required)?this.required=this.options.required:this.required=false}});return i}();o.setDefaults=function(t){o.DEFAULTS=e.extend(o.DEFAULTS,t||{})};o.bindFormSubmit=function(t){if(!a){new o.Submittable(t);t.bind("submit",this.onFormSubmit);a=true}};o.onBeforeSubmit=function(t){var i=0;e.each(o.instances,(function(e,n){i+=e.onFormSubmit(t)}));o.log("Total errors: "+i);return i};o.onFormSubmit=function(t){var e=o.onBeforeSubmit();if(e>0){o.EventBus.trigger("onError");t.preventDefault()}};o.getInstance=function(t){if(e.isUndefined(t))return this.instances[0];if(e.isString(t))return e.find(this.instances,(function(e){return e.ID===t}));return this.instances[t]};o.setBlockOptions=function(t,i){var n=o.Blocks[t];if(e.isUndefined(n))return;e.extend(n.prototype,i||{})};o.runOnAllInstances=function(t){if(e.has(o.Editor.prototype,t)){[].unshift.call(arguments,o.instances);e.invoke.apply(e,arguments)}else o.log("method doesn't exist")}})(n,o);t.exports=SirTrevor}}]);